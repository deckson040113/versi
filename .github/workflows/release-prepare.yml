name: Prepare Release
on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      prerelease:
        description: "Pre-release identifier (e.g., alpha, beta, rc.1). Leave empty for stable release."
        required: false
        default: ""
        type: string
concurrency:
  group: release-prepare
  cancel-in-progress: false
env:
  CARGO_TERM_COLOR: always
jobs:
  prepare:
    name: Prepare Release PR
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get current version
        id: current
        run: |
          CURRENT_VERSION=$(grep -m1 '^version' Cargo.toml | sed 's/.*"\(.*\)".*/\1/')
          echo "Current version: $CURRENT_VERSION"
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Calculate new version
        id: bump
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          BUMP="${{ inputs.bump }}"
          PRERELEASE="${{ inputs.prerelease }}"

          # Check if current version has a prerelease suffix
          CURRENT_BASE="${CURRENT%%-*}"
          CURRENT_PRERELEASE="${CURRENT#*-}"
          if [ "$CURRENT_PRERELEASE" = "$CURRENT" ]; then
            CURRENT_PRERELEASE=""
          fi

          # Parse base version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_BASE"

          # Only bump if: no prerelease requested, OR current has no prerelease
          # (i.e., don't bump when going from prerelease to prerelease)
          if [ -z "$PRERELEASE" ] || [ -z "$CURRENT_PRERELEASE" ]; then
            case "$BUMP" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac
          fi

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"

          if [ -n "$PRERELEASE" ]; then
            NEW_VERSION="$NEW_VERSION-$PRERELEASE"
          fi

          TAG="v$NEW_VERSION"
          BRANCH="release/$TAG"

          echo "New version: $NEW_VERSION"
          echo "Tag: $TAG"
          echo "Branch: $BRANCH"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ steps.bump.outputs.version }}"
          TODAY=$(date +%Y-%m-%d)

          # Get the previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          # Generate commit list
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Generating changelog from $PREVIOUS_TAG to HEAD"
            COMMITS=$(git log --pretty=format:"- %s" "$PREVIOUS_TAG"..HEAD --no-merges | grep -v "^- chore: bump version" || true)
          else
            echo "No previous tag found, generating full changelog"
            COMMITS=$(git log --pretty=format:"- %s" --no-merges | grep -v "^- chore: bump version" || true)
          fi

          # Build the new changelog section
          {
            echo "## [$VERSION] - $TODAY"
            echo ""
            if [ -n "$COMMITS" ]; then
              echo "$COMMITS"
            else
              echo "- Initial release"
            fi
            echo ""
          } > new_section.txt

          cat new_section.txt

      - name: Update CHANGELOG.md
        run: |
          if [ -f CHANGELOG.md ]; then
            # Insert new section after the header
            head -n 4 CHANGELOG.md > CHANGELOG.new.md
            echo "" >> CHANGELOG.new.md
            cat new_section.txt >> CHANGELOG.new.md
            tail -n +5 CHANGELOG.md >> CHANGELOG.new.md
            mv CHANGELOG.new.md CHANGELOG.md
          else
            # Create new CHANGELOG.md
            {
              echo "# Changelog"
              echo ""
              echo "All notable changes to this project will be documented in this file."
              echo ""
              cat new_section.txt
            } > CHANGELOG.md
          fi

          rm new_section.txt
          cat CHANGELOG.md

      - name: Update Cargo.toml version
        run: |
          NEW_VERSION="${{ steps.bump.outputs.version }}"
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" Cargo.toml
          echo "Updated Cargo.toml to version $NEW_VERSION"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Update Cargo.lock
        run: cargo check

      - name: Create release branch and push
        run: |
          TAG="${{ steps.bump.outputs.tag }}"
          BRANCH="${{ steps.bump.outputs.branch }}"

          git checkout -b "$BRANCH"
          git add Cargo.toml Cargo.lock CHANGELOG.md
          git commit -m "chore: release $TAG"
          git push --force origin "$BRANCH"

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          VERSION: ${{ steps.bump.outputs.version }}
          TAG: ${{ steps.bump.outputs.tag }}
        run: |
          gh pr create \
            --title "Release $TAG" \
            --body "## Release $TAG

          This PR prepares the release of version $VERSION.

          ### Changes
          - Updated version in Cargo.toml to $VERSION
          - Updated CHANGELOG.md with changes since last release

          ### After Merge
          When this PR is merged, the release workflow will automatically create the git tag, build release artifacts, and create the GitHub Release." \
            --label "release" \
            --base main
